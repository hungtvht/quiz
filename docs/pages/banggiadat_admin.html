<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n tr·ªã d·ªØ li·ªáu gi√° ƒë·∫•t H√† Tƒ©nh</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="../js/normalizeVietnameseText.js"></script>
    <script src="../js/custom.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="bg-gray-50 p-6">
    <div class="max-w-5xl mx-auto text-center">
      <h1 class="text-2xl font-bold mb-4 text-blue-700">
        ‚öôÔ∏è Qu·∫£n tr·ªã d·ªØ li·ªáu b·∫£ng gi√° ƒë·∫•t H√† Tƒ©nh
      </h1>
      <p class="text-gray-600 mb-6">
        K√©o th·∫£ file Excel (c√≥ sheet ODT, ONT) v√†o ƒë√¢y ƒë·ªÉ chu·∫©n h√≥a th√†nh
        <b>data.json</b>.
      </p>

      <!-- Khu v·ª±c k√©o th·∫£ -->
      <div
        id="dropzone"
        class="border-4 border-dashed border-blue-400 rounded-xl p-10 bg-white shadow cursor-pointer hover:bg-blue-50 transition"
      >
        <p class="text-gray-500">
          üìÇ K√©o & th·∫£ file Excel v√†o ƒë√¢y ho·∫∑c click ƒë·ªÉ ch·ªçn
        </p>
        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" />
      </div>

      <!-- Danh s√°ch sheet -->
      <div
        id="sheetSelector"
        class="hidden mt-6 bg-white p-4 rounded-xl shadow text-left"
      >
        <h2 class="text-lg font-semibold mb-2">üîí Ch·ªçn sheet c·∫ßn x·ª≠ l√Ω:</h2>
        <div
          id="sheetList"
          class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 text-gray-700"
        ></div>
        <button
          id="processBtn"
          class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
        >
          ‚öôÔ∏è X·ª≠ l√Ω d·ªØ li·ªáu [OƒêT]
        </button>
        <button
          id="processBtn2"
          class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
        >
          ‚öôÔ∏è X·ª≠ l√Ω d·ªØ li·ªáu [ONT]
        </button>
      </div>

      <div id="status" class="mt-6 text-gray-600 text-left"></div>
      <button
        id="downloadBtn"
        class="hidden bg-green-600 text-white px-6 py-2 rounded-lg mt-6"
      >
        ‚¨áÔ∏è T·∫£i xu·ªëng data.json
      </button>
      <button
        id="saveJsonBtn"
        class="hidden bg-green-600 text-white px-6 py-2 rounded-lg mt-6"
      >
        üíæ L∆∞u JSON l√™n server
      </button>
      <div
        id="saveStatus"
        class="hidden bg-green-600 text-white px-6 py-2 rounded-lg mt-6"
      ></div>
    </div>

    <script>
      const dropzone = document.getElementById("dropzone");
      const fileInput = document.getElementById("fileInput");
      const sheetSelector = document.getElementById("sheetSelector");
      const sheetList = document.getElementById("sheetList");
      const processBtn = document.getElementById("processBtn");
      const processBtn2 = document.getElementById("processBtn2");
      const statusEl = document.getElementById("status");
      const downloadBtn = document.getElementById("downloadBtn");
      const saveJsonBtn = document.getElementById("saveJsonBtn");

      let workbookGlobal = null;
      let allData = [];

      // ========= K√©o & th·∫£ ==========
      dropzone.addEventListener("click", () => fileInput.click());
      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("bg-blue-100");
      });
      dropzone.addEventListener("dragleave", () =>
        dropzone.classList.remove("bg-blue-100")
      );
      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("bg-blue-100");
        const file = e.dataTransfer.files[0];
        handleFile(file);
      });
      fileInput.addEventListener("change", (e) =>
        handleFile(e.target.files[0])
      );

      // ========= ƒê·ªçc file Excel ==========
      async function handleFile(file) {
        if (!file) return;
        statusEl.innerHTML = `üìñ ƒêang ƒë·ªçc file <b>${file.name}</b>...`;
        const data = await file.arrayBuffer();
        workbookGlobal = XLSX.read(data, { type: "array" });
        showSheetSelector(workbookGlobal.SheetNames);
      }

      // ========= Hi·ªÉn th·ªã danh s√°ch sheet ==========
      function showSheetSelector(sheetNames) {
        sheetList.innerHTML = "";
        sheetSelector.classList.remove("hidden");
        statusEl.innerHTML = "";

        sheetNames.forEach((name) => {
          const div = document.createElement("div");
          div.className =
            "flex items-center gap-2 p-2 border rounded-lg hover:bg-blue-50";
          div.innerHTML = `<input type="checkbox" value="${name}" class="sheetCheckbox"> <span>${name}</span>`;
          sheetList.appendChild(div);
        });
      }

      // ========= Khi nh·∫•n "X·ª≠ l√Ω d·ªØ li·ªáu" ==========
      processBtn.addEventListener("click", () => {
        const selected = [
          ...document.querySelectorAll(".sheetCheckbox:checked"),
        ].map((cb) => cb.value);
        if (selected.length === 0) {
          alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 sheet ƒë·ªÉ x·ª≠ l√Ω!");
          return;
        }
        processSelectedSheets(selected);
      });
      processBtn2.addEventListener("click", () => {
        const selected = [
          ...document.querySelectorAll(".sheetCheckbox:checked"),
        ].map((cb) => cb.value);
        if (selected.length === 0) {
          alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 sheet ƒë·ªÉ x·ª≠ l√Ω!");
          return;
        }
        processSelectedSheets2(selected);
      });

      // ========= X·ª≠ l√Ω sheet ƒë√£ ch·ªçn ==========
      function processSelectedSheets(selectedSheets) {
        allData = [];
        statusEl.innerHTML = "";

        selectedSheets.forEach((sheetName) => {
          const sheet = XLSX.utils.sheet_to_json(
            workbookGlobal.Sheets[sheetName],
            { defval: "" }
          );
          const cleanData = processSheet(sheet, sheetName);
          allData.push(...cleanData);
          statusEl.innerHTML += `<div>‚úÖ <b>${sheetName}</b>: ${cleanData.length} d√≤ng h·ª£p l·ªá</div>`;
        });

        statusEl.innerHTML += `<br><b>üéØ T·ªïng c·ªông: ${allData.length} b·∫£n ghi</b>`;
        downloadBtn.classList.remove("hidden");
        saveJsonBtn.classList.remove("hidden");
      }
      function processSelectedSheets2(selectedSheets) {
        allData = [];
        statusEl.innerHTML = "";

        selectedSheets.forEach((sheetName) => {
          const sheet = XLSX.utils.sheet_to_json(
            workbookGlobal.Sheets[sheetName],
            { defval: "" }
          );
          const cleanData = processSheet2(sheet, sheetName);
          allData.push(...cleanData);
          statusEl.innerHTML += `<div>‚úÖ <b>${sheetName}</b>: ${cleanData.length} d√≤ng h·ª£p l·ªá</div>`;
        });

        statusEl.innerHTML += `<br><b>üéØ T·ªïng c·ªông: ${allData.length} b·∫£n ghi</b>`;
        downloadBtn.classList.remove("hidden");
        saveJsonBtn.classList.remove("hidden");
      }

      // ========= Chu·∫©n h√≥a d·ªØ li·ªáu 1 sheet (D·∫°ng A I I.1 1) ==========
      function processSheet(rows, sheetName) {
        const result = [];
        let khu_vuc = "";
        let dia_ban = "";
        let thong_tin_khac = "";
        let ten_duong = "";

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const vals = Object.values(row).map((v) =>
            (v || "").toString().trim()
          );
          if (vals.every((v) => v === "")) continue;

          const colA = vals[0] || "";
          const colD = normalizeVietnameseText(vals[3]) || "";
          const colE = parseFloat(vals[4]?.replace(/[^\d.]/g, "")) || 0;
          const colF = parseFloat(vals[5]?.replace(/[^\d.]/g, "")) || 0;
          const colG = parseFloat(vals[6]?.replace(/[^\d.]/g, "")) || 0;

          // B·ªè ti√™u ƒë·ªÅ
          if (
            /t√™n ƒë∆∞·ªùng|ƒë∆°n gi√°|h·ªá s·ªë|th·ªã tr∆∞·ªùng|^STT$/i.test(colD) ||
            /^STT$/i.test(colA)
          )
            continue;

          if (colG > 0) {
            // D√≤ng chi ti·∫øt c√≥ gi√°
            const cleanA = colA.trim();
            const cleanD = colD.trim();
            if (/^[A-Z]$/.test(cleanA)) {
              khu_vuc = cleanD;
              dia_ban = "";
              thong_tin_khac = "";
              ten_duong = "";
            }
            result.push({
              sheet: sheetName,
              khu_vuc,
              dia_ban,
              thong_tin_khac,
              ten_duong,
              doan_duong: colD,
              don_gia_qd: colE,
              he_so_k: colF,
              gia_thi_truong: colG,
            });
          } else {
            const cleanA = colA.trim();
            const cleanD = colD.trim();
            if (!cleanD) continue;

            // C·∫•p 1: Ch·ªØ c√°i ƒë∆°n (A, B, C...) ‚Üí Khu v·ª±c
            if (/^[A-Z]$/.test(cleanA) && !isValidRoman(cleanA)) {
              khu_vuc = cleanD;
              dia_ban = "";
              thong_tin_khac = "";
              ten_duong = "";
              console.log("Khu v·ª±c m·ªõi:", khu_vuc);
            }
            // C·∫•p 2: S·ªë La M√£ thu·∫ßn (I, II, III...) ‚Üí ƒê·ªãa b√†n
            else if (
              /^(I|II|III|IV|V|VI|VII|VIII|IX|X|XI|XII)$/i.test(cleanA)
            ) {
              dia_ban = cleanD;
              thong_tin_khac = "";
              ten_duong = "";
            }
            // C·∫•p 3: S·ªë La M√£ + d·∫•u ch·∫•m (I.1, I.2, II.3...) ‚Üí Th√¥ng tin kh√°c
            else if (/^(I|II|III|IV|V|VI|VII|VIII|IX|X)\.\d+$/i.test(cleanA)) {
              thong_tin_khac = cleanD;
              ten_duong = "";
            }
            // C·∫•p 4: S·ªë th·∫≠p ph√¢n (1.1, 2.3...) ‚Üí Th√¥ng tin kh√°c (n·∫øu ch∆∞a ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü tr√™n)
            else if (/^\d+\.\d+$/.test(cleanA)) {
              thong_tin_khac = cleanD;
              ten_duong = "";
            }
            // C·∫•p 5: S·ªë nguy√™n (1, 2, 3...) ‚Üí C√≥ th·ªÉ l√† t√™n ƒë∆∞·ªùng ho·∫∑c ƒë·ªãa b√†n/th√¥ng tin kh√°c
            else if (/^\d+$/.test(cleanA)) {
              if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(cleanD)) {
                // D·ª± ƒëo√°n l√† t√™n ƒë∆∞·ªùng n·∫øu c√≥ d√≤ng con c√≥ gi√°
                let foundChiTiet = false;
                for (let j = i + 1; j < Math.min(i + 15, rows.length); j++) {
                  const nextVals = Object.values(rows[j]);
                  const gVal = parseFloat(
                    (nextVals[6] || "").toString().replace(/[^\d.]/g, "")
                  );
                  if (gVal > 0) {
                    foundChiTiet = true;
                    break;
                  }
                  const nextD = (nextVals[3] || "").toString().trim();
                  if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(nextD)) break;
                }
                if (foundChiTiet) {
                  ten_duong = cleanD;
                } else {
                  thong_tin_khac = cleanD;
                  ten_duong = "";
                }
              } else if (
                /^(TP|TX|Th√†nh ph·ªë|Th·ªã x√£|Huy·ªán|X√£|Ph∆∞·ªùng|Th·ªã tr·∫•n)/i.test(
                  cleanD
                )
              ) {
                dia_ban = cleanD;
                thong_tin_khac = "";
                ten_duong = "";
              } else {
                thong_tin_khac = cleanD;
                ten_duong = "";
              }
            }
            // C·∫•p 6: Kh√¥ng c√≥ STT r√µ r√†ng ‚Üí X·ª≠ l√Ω nh∆∞ t√™n ƒë∆∞·ªùng ho·∫∑c th√¥ng tin kh√°c
            else {
              if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(cleanD)) {
                let foundChiTiet = false;
                for (let j = i + 1; j < Math.min(i + 15, rows.length); j++) {
                  const nextVals = Object.values(rows[j]);
                  const gVal = parseFloat(
                    (nextVals[6] || "").toString().replace(/[^\d.]/g, "")
                  );
                  if (gVal > 0) {
                    foundChiTiet = true;
                    break;
                  }
                  const nextD = (nextVals[3] || "").toString().trim();
                  if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(nextD)) break;
                }
                if (foundChiTiet) {
                  ten_duong = cleanD;
                } else {
                  thong_tin_khac = cleanD;
                  ten_duong = "";
                }
              } else {
                thong_tin_khac = cleanD;
              }
            }
          }
        }

        return result;
      }

      // ========= Chu·∫©n h√≥a d·ªØ li·ªáu 1 sheet (D·∫°ng I 1 1.1) ==========
      function processSheet2(rows, sheetName) {
        const result = [];
        let khu_vuc = "";
        let dia_ban = "";
        let thong_tin_khac = "";
        let ten_duong = "";

        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          const vals = Object.values(row).map((v) =>
            (v || "").toString().trim()
          );
          if (vals.every((v) => v === "")) continue;

          const colA = vals[0] || "";
          const colD = normalizeVietnameseText(vals[3]) || "";
          const colE = parseFloat(vals[4]?.replace(/[^\d.]/g, "")) || 0;
          const colF = parseFloat(vals[5]?.replace(/[^\d.]/g, "")) || 0;
          const colG = parseFloat(vals[6]?.replace(/[^\d.]/g, "")) || 0;

          // B·ªè ti√™u ƒë·ªÅ
          if (
            /t√™n ƒë∆∞·ªùng|ƒë∆°n gi√°|h·ªá s·ªë|th·ªã tr∆∞·ªùng|^STT$/i.test(colD) ||
            /^STT$/i.test(colA)
          )
            continue;

          if (colG > 0) {
            // D√≤ng chi ti·∫øt c√≥ gi√°
            const cleanA = colA.trim();
            const cleanD = colD.trim();

            result.push({
              sheet: sheetName,
              khu_vuc,
              dia_ban,
              thong_tin_khac,
              ten_duong,
              doan_duong: colD,
              don_gia_qd: colE,
              he_so_k: colF,
              gia_thi_truong: colG,
            });
          } else {
            const cleanA = colA.trim();
            const cleanD = colD.trim();
            if (!cleanD) continue;

            // C·∫•p 1: La M√£ (I, II, III...) ‚Üí Khu v·ª±c
            if (/^(I|II|III|IV|V|VI|VII|VIII|IX|X|XI|XII)$/i.test(cleanA)) {
              khu_vuc = cleanD;
              dia_ban = "";
              thong_tin_khac = "";
              ten_duong = "";
              console.log("Khu v·ª±c m·ªõi:", khu_vuc);
            }
            // C·∫•p 2: S·ªë thu·∫ßn (1, 2, 3...) ‚Üí ƒê·ªãa b√†n
            else if (/^[1-9]\d*$/i.test(cleanA)) {
              dia_ban = cleanD;
              thong_tin_khac = "";
              ten_duong = "";
            }

            // C·∫•p 3: S·ªë th·∫≠p ph√¢n (1.1, 2.3...) ‚Üí Th√¥ng tin kh√°c (n·∫øu ch∆∞a ƒë∆∞·ª£c x·ª≠ l√Ω ·ªü tr√™n)
            else if (/^\d+\.\d+$/.test(cleanA)) {
              thong_tin_khac = cleanD;
              ten_duong = "";
            }
            // C·∫•p 5: S·ªë nguy√™n (1, 2, 3...) ‚Üí C√≥ th·ªÉ l√† t√™n ƒë∆∞·ªùng ho·∫∑c ƒë·ªãa b√†n/th√¥ng tin kh√°c
            else if (/^\d+$/.test(cleanA)) {
              if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(cleanD)) {
                // D·ª± ƒëo√°n l√† t√™n ƒë∆∞·ªùng n·∫øu c√≥ d√≤ng con c√≥ gi√°
                let foundChiTiet = false;
                for (let j = i + 1; j < Math.min(i + 15, rows.length); j++) {
                  const nextVals = Object.values(rows[j]);
                  const gVal = parseFloat(
                    (nextVals[6] || "").toString().replace(/[^\d.]/g, "")
                  );
                  if (gVal > 0) {
                    foundChiTiet = true;
                    break;
                  }
                  const nextD = (nextVals[3] || "").toString().trim();
                  if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(nextD)) break;
                }
                if (foundChiTiet) {
                  ten_duong = cleanD;
                } else {
                  thong_tin_khac = cleanD;
                  ten_duong = "";
                }
              } else if (
                /^(TP|TX|Th√†nh ph·ªë|Th·ªã x√£|Huy·ªán|X√£|Ph∆∞·ªùng|Th·ªã tr·∫•n)/i.test(
                  cleanD
                )
              ) {
                dia_ban = cleanD;
                thong_tin_khac = "";
                ten_duong = "";
              } else {
                thong_tin_khac = cleanD;
                ten_duong = "";
              }
            }
            // C·∫•p 6: Kh√¥ng c√≥ STT r√µ r√†ng ‚Üí X·ª≠ l√Ω nh∆∞ t√™n ƒë∆∞·ªùng ho·∫∑c th√¥ng tin kh√°c
            else {
              if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(cleanD)) {
                let foundChiTiet = false;
                for (let j = i + 1; j < Math.min(i + 15, rows.length); j++) {
                  const nextVals = Object.values(rows[j]);
                  const gVal = parseFloat(
                    (nextVals[6] || "").toString().replace(/[^\d.]/g, "")
                  );
                  if (gVal > 0) {
                    foundChiTiet = true;
                    break;
                  }
                  const nextD = (nextVals[3] || "").toString().trim();
                  if (/^(ƒê∆∞·ªùng|Ng√µ|T·ªï|Khu|Ph·∫ßn|Ph·ªë)/i.test(nextD)) break;
                }
                if (foundChiTiet) {
                  ten_duong = cleanD;
                } else {
                  thong_tin_khac = cleanD;
                  ten_duong = "";
                }
              } else {
                thong_tin_khac = cleanD;
              }
            }
          }
        }

        return result;
      }
      // ========= T·∫£i xu·ªëng JSON ==========
      downloadBtn.addEventListener("click", () => {
        const blob = new Blob([JSON.stringify(allData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      saveJsonBtn.addEventListener("click", async () => {
        alert("ƒêang tri·ªÉn khai!");
        return;
        try {
          const res = await fetch("/save-json", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(finalData, null, 2),
          });

          const result = await res.json();
          if (result.success) {
            document.getElementById("saveStatus").innerHTML =
              "‚úÖ ƒê√£ l∆∞u JSON th√†nh c√¥ng t·∫°i: " + result.path;
          } else {
            document.getElementById("saveStatus").innerHTML =
              "‚ùå L·ªói khi l∆∞u JSON: " + result.error;
          }
        } catch (err) {
          console.error("L·ªói khi l∆∞u JSON:", err);
          document.getElementById("saveStatus").innerHTML =
            "‚ö†Ô∏è Kh√¥ng th·ªÉ k·∫øt n·ªëi server.";
        }
      });
    </script>
  </body>
</html>
